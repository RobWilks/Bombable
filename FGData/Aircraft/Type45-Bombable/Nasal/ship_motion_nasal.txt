	<nasal>
		<load>
			var wind_node =
			props.globals.getNode("/environment/wind-speed-kt");
			var time_node =
			props.globals.getNode("/sim/time/elapsed-sec");
			var
			roll_node =
			props.globals.getNode("/ai/models/Type45/roll");
			var
			pitch_node =
			props.globals.getNode("/ai/models/Type45/pitch");
			var
			heave_node =
			props.globals.getNode("/ai/models/Type45/heave");
			var
			loopid = 1;
			
			
			var loop = func(id) {
				if (id != loopid) return;

				var
				rollperiod = 11.0;
				var pitchperiod = 5.0;
				var heaveperiod =
				pitchperiod;
				var heavedelay = pitchperiod*0.75;

				var rolltimer =
				time_node.getValue()/rollperiod -
				int(time_node.getValue()/rollperiod);
				var roll =
				math.sin(2*math.pi*rolltimer);
				roll_node.setValue(roll*(wind_node.getValue()+1));

				var pitchtimer =
				time_node.getValue()/pitchperiod -
				int(time_node.getValue()/pitchperiod);
				var pitch =
				math.sin(2*math.pi*pitchtimer);
				pitch_node.setValue(pitch*(wind_node.getValue()+1));

				var heavetimer =
				(time_node.getValue()+heavedelay)/heaveperiod -
				int((time_node.getValue()+heavedelay)/heaveperiod);
				var heave =
				math.cos(2*math.pi*heavetimer);
				heave_node.setValue(heave*(wind_node.getValue()+1));

				settimer(func {
				loop(id); }, 1);
			}
			
			settimer(func { loop(loopid); }, 0);
 
		</load>
		<unload>
			loopid += 1;			
		</unload>
	</nasal>

	<!-- Effects -->
	
	<nasal>
		<load>
		
			print("LOAD HMS_Duncan", cmdarg().getPath());

			var fg_root =
			getprop("/sim/fg-root");
			var self = cmdarg();

			<!-- Properties used to calculate rel wind for the bow-wave shader -->
			var speed_Node = self.getNode("velocities/speed-kts", 1);
			var hdg_Node
			= self.getNode("orientation/true-heading-deg", 1);
			var wind_speed_Node
			= self.getNode("environment/rel-wind-speed-kts", 1);
			wind_speed_Node.setDoubleValue(0);

			loop2id = 1;

			<!-- The main loop -->
			var update = func(id) {
				if (id != loop2id) return;
				var value = wind_speed_Node.getValue();
				setprop("/environment/Type45/rel-wind-speed-kts", value);
				value =
				speed_Node.getValue();
				setprop("/environment/Type45/spd-kt", value);
				value = hdg_Node.getValue();
				setprop("/environment/Type45/hdg-deg",
				value);

				settimer(update(loop2id),1);
			}

			<!-- Start the main loop -->
			update(loop2id);

		</load>
	</nasal>

	<unload>
		#print("UNLOAD HMS_Duncan ", cmdarg().getPath());
		loop2id += 1;	#stop second timer		
	</unload>